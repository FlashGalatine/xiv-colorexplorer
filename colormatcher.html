<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV Dye Color Matcher v1.2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        body.dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }
        body.dark-mode .bg-white {
            background-color: #374151;
        }
        body.dark-mode .text-gray-800 {
            color: #f9fafb;
        }
        body.dark-mode .text-gray-900 {
            color: #f9fafb;
        }
        body.dark-mode .text-gray-600 {
            color: #d1d5db;
        }
        body.dark-mode .text-gray-500 {
            color: #9ca3af;
        }
        body.dark-mode h1 .text-gray-500 {
            color: #6b7280;
        }
        body.dark-mode .text-indigo-600 {
            color: #818cf8;
        }
        body.dark-mode .text-indigo-600:hover {
            color: #a5b4fc;
        }
        body.dark-mode .border-gray-300 {
            border-color: #4b5563;
        }
        body.dark-mode .border-gray-200 {
            border-color: #4b5563;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #4b5563;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #374151;
        }
        body.dark-mode #dark-mode-toggle {
            background-color: #4b5563;
            color: #f9fafb;
        }
        body.dark-mode #dark-mode-toggle:hover {
            background-color: #374151;
        }
        body.dark-mode #imageLoader {
            color: #d1d5db;
        }
        body.dark-mode #imageLoader::file-selector-button {
            background-color: #4b5563;
            color: #f9fafb;
        }
        body.dark-mode #imageLoader::file-selector-button:hover {
            background-color: #374151;
        }
        body.dark-mode #clearImageBtn {
            background-color: #7f1d1d;
            color: #fca5a5;
        }
        body.dark-mode #clearImageBtn:hover {
            background-color: #991b1b;
        }
        body.dark-mode #zoomInBtn,
        body.dark-mode #zoomOutBtn,
        body.dark-mode #zoomToFitBtn,
        body.dark-mode #zoomToWidthBtn,
        body.dark-mode #resetZoomBtn {
            background-color: #4b5563;
            color: #f9fafb;
        }
        body.dark-mode #zoomInBtn:hover,
        body.dark-mode #zoomOutBtn:hover,
        body.dark-mode #zoomToFitBtn:hover,
        body.dark-mode #zoomToWidthBtn:hover,
        body.dark-mode #resetZoomBtn:hover {
            background-color: #374151;
        }
        body.dark-mode #zoomLevel {
            color: #f9fafb;
        }
        body.dark-mode #canvasWrapper {
            background-color: #1f2937;
        }
        #canvasWrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .color-swatch {
            width: 100px;
            height: 100px;
            border-radius: 0.5rem;
            border: 2px solid rgba(0,0,0,0.1);
        }
        #imageCanvas {
            cursor: crosshair;
        }
        #eyedropperPreview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px black, 0 4px 8px rgba(0,0,0,0.2);
            position: absolute;
            pointer-events: none;
            display: none;
            z-index: 10;
        }
        .drag-over {
            border: 4px dashed #3b82f6; /* blue-500 */
            background-color: rgba(59, 130, 246, 0.1);
        }
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .nav-dropdown-toggle {
            background-color: transparent;
            border: none;
            color: #4f46e5;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
        }
        .nav-dropdown-toggle:hover {
            color: #4338ca;
        }
        body.dark-mode .nav-dropdown-toggle {
            color: #818cf8;
        }
        body.dark-mode .nav-dropdown-toggle:hover {
            color: #a5b4fc;
        }
        .nav-dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            min-width: 200px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            margin-top: 0.5rem;
        }
        body.dark-mode .nav-dropdown-menu {
            background-color: #374151;
            border-color: #4b5563;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }
        .nav-dropdown-menu.show {
            display: block;
        }
        .nav-dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #1f2937;
            text-decoration: none;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }
        .nav-dropdown-item:hover {
            background-color: #f3f4f6;
        }
        body.dark-mode .nav-dropdown-item {
            color: #f9fafb;
        }
        body.dark-mode .nav-dropdown-item:hover {
            background-color: #4b5563;
        }
        .nav-dropdown-item:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
        body.dark-mode .nav-dropdown-item:not(:last-child) {
            border-bottom-color: #4b5563;
        }
        /* Toggle switch styles */
        .toggle-bg {
            background-color: #d1d5db;
            transition: background-color 0.3s ease;
        }
        input:checked + .toggle-bg {
            background-color: #4f46e5;
        }
        .toggle-dot {
            transition: left 0.3s ease;
        }
        input:checked + .toggle-bg + .toggle-dot {
            left: calc(100% - 1.25rem);
        }
        body.dark-mode .toggle-bg {
            background-color: #4b5563;
        }
        body.dark-mode input:checked + .toggle-bg {
            background-color: #6366f1;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #4b5563;
        }
        body.dark-mode .bg-gray-50 .text-gray-700 {
            color: #e5e7eb;
        }
        /* Market Board Server Select Dark Mode */
        body.dark-mode #mb-server-select {
            background-color: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        body.dark-mode #mb-server-select option {
            background-color: #374151;
            color: #f9fafb;
        }
        body.dark-mode #mb-server-select optgroup {
            background-color: #374151;
            color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="mainContainer" class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-6 md:p-8 transition-all duration-300">
        
        <div class="text-center mb-8">
            <div class="flex justify-center items-center gap-4 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">FFXIV Dye Color Matcher <span class="text-2xl md:text-3xl text-gray-500">v1.2.0</span></h1>
                <button id="dark-mode-toggle" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition text-gray-700" title="Toggle dark mode">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
            <p class="text-gray-600 mt-2">
                Pick a color or upload an image to find the closest dye match.
                <div class="nav-dropdown inline-block ml-4">
                    <button class="nav-dropdown-toggle" onclick="toggleDropdown(this)">
                        Tools â–¼
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="colorexplorer_stable.html" class="nav-dropdown-item">Color Harmony Explorer</a>
                        <a href="colormatcher.html" class="nav-dropdown-item">Color Matcher</a>
                        <a href="dyecomparison.html" class="nav-dropdown-item">Dye Comparison</a>
                        <a href="index.html" class="nav-dropdown-item">All Tools</a>
                    </div>
                </div>
            </p>
        </div>

        <!-- Input Section -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            <div class="flex items-center gap-4 bg-gray-100 p-3 rounded-lg">
                <label for="colorPicker" class="font-medium text-lg">Your Color:</label>
                <input type="color" id="colorPicker" value="#8A2BE2" class="w-14 h-14 p-1 bg-white rounded-md cursor-pointer">
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="grid md:grid-cols-2 gap-8 text-center">
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4">Your Pick</h2>
                <div id="userColor" class="color-swatch mx-auto mb-4"></div>
                <p id="userHex" class="font-mono text-lg"></p>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4">Closest Dye Match</h2>
                <div id="matchedColor" class="color-swatch mx-auto mb-4"></div>
                <p id="matchedName" class="text-lg font-medium"></p>
                <p id="matchedHex" class="font-mono text-lg"></p>
            </div>
        </div>

        <!-- Market Board Section -->
        <div class="mt-10 pt-8 border-t border-gray-200">
            <div class="mb-8">
                <label for="mb-server-select" class="block text-lg font-semibold text-gray-900 mb-3">Market Board Server:</label>
                <select id="mb-server-select" class="w-full max-w-md px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Price Data Controls -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold text-gray-700">Market Prices</h3>
                    <label class="flex items-center cursor-pointer">
                        <span class="mr-2 text-xs text-gray-600">Show</span>
                        <div class="relative">
                            <input id="show-mb-prices-toggle" type="checkbox" class="sr-only" checked>
                            <div class="toggle-bg w-10 h-6 bg-gray-300 rounded-full shadow-inner"></div>
                            <div class="toggle-dot absolute w-4 h-4 bg-white rounded-full shadow inset-y-1 left-1 transition"></div>
                        </div>
                    </label>
                </div>
                <div id="mb-price-settings">
                    <div class="space-y-1.5 mb-3">
                        <div class="flex items-center">
                            <input id="mb-price-base" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mb-price-checkbox">
                            <label for="mb-price-base" class="ml-2 block text-xs text-gray-700">Base Dyes</label>
                        </div>
                        <div class="flex items-center">
                            <input id="mb-price-craft" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mb-price-checkbox">
                            <label for="mb-price-craft" class="ml-2 block text-xs text-gray-700">Craft Dyes</label>
                        </div>
                        <div class="flex items-center">
                            <input id="mb-price-beast" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mb-price-checkbox">
                            <label for="mb-price-beast" class="ml-2 block text-xs text-gray-700">Beast Tribe Dyes</label>
                        </div>
                        <div class="flex items-center">
                            <input id="mb-price-cosmic" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mb-price-checkbox">
                            <label for="mb-price-cosmic" class="ml-2 block text-xs text-gray-700">Cosmic Dyes</label>
                        </div>
                        <div class="flex items-center">
                            <input id="mb-price-special" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mb-price-checkbox">
                            <label for="mb-price-special" class="ml-2 block text-xs text-gray-700">Special Dyes</label>
                        </div>
                    </div>
                    <button id="mb-refresh-btn" onclick="refreshMarketPricesMatcher()" class="w-full px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" disabled>
                        Refresh Prices
                    </button>
                    <div id="mb-price-status" class="mt-2 text-xs text-gray-500 text-center"></div>
                </div>
            </div>
        </div>

        <!-- Image Uploader and Eyedropper Section -->
        <div class="mt-10 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-semibold text-center mb-4">Or... Pick from an Image</h2>
            <div id="upload-prompt" class="text-center text-gray-500">
                <p>Drag & drop an image anywhere, or</p>
            </div>
            <div class="flex flex-col items-center gap-4 mt-2">
                <div class="w-full max-w-md">
                   <label for="imageLoader" class="sr-only">Choose a file</label>
                   <input type="file" name="imageLoader" id="imageLoader" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer"/>
                </div>
                <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-4 mt-2">
                    <div class="flex items-center gap-2">
                        <label for="sampleSize" class="font-medium">Sample Size:</label>
                        <select id="sampleSize" class="bg-gray-100 border border-gray-300 rounded-md p-2">
                            <option value="1">1x1</option>
                            <option value="2">2x2</option>
                            <option value="4">4x4</option>
                            <option value="16" selected>16x16</option>
                            <option value="32">32x32</option>
                            <option value="64">64x64</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="excludeMetallic" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                        <label for="excludeMetallic" class="font-medium">Exclude Metallic Dyes</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="excludeExtremes" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                        <label for="excludeExtremes" class="font-medium">Exclude Pure White & Jet Black</label>
                    </div>
                </div>
            </div>
            <div id="imageContainer" class="mt-4 w-full relative" style="display: none;">
                <div class="flex justify-center items-center gap-3 mb-4">
                    <button id="clearImageBtn" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium text-sm">
                        Clear Image
                    </button>
                    <div class="flex items-center gap-2 bg-gray-100 p-2 rounded-lg">
                        <button id="zoomOutBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition text-gray-700 font-medium text-sm" title="Zoom Out (- or Shift+MouseWheel)">
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                            </svg>
                        </button>
                        <span id="zoomLevel" class="text-sm font-medium text-gray-700 min-w-[60px] text-center">100%</span>
                        <button id="zoomInBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition text-gray-700 font-medium text-sm" title="Zoom In (+ or Shift+MouseWheel)">
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                            </svg>
                        </button>
                        <button id="zoomToFitBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition text-gray-700 font-medium text-sm" title="Zoom to Fit (Shift+MiddleClick)">
                            Fit
                        </button>
                        <button id="zoomToWidthBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition text-gray-700 font-medium text-sm" title="Zoom to Width (W)">
                            Width
                        </button>
                        <button id="resetZoomBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition text-gray-700 font-medium text-sm" title="Reset Zoom (R or Shift+RightClick)">
                            Reset
                        </button>
                    </div>
                </div>
                <p class="text-center text-gray-500 mb-2">Hover and click on the image to pick a color. Use Shift+Left Drag to pan, Shift+Wheel to zoom.</p>
                <div id="canvasWrapper" class="w-full overflow-auto rounded-lg shadow-md" style="max-height: 700px;">
                    <canvas id="imageCanvas" class=""></canvas>
                </div>
                <div id="eyedropperPreview"></div>
            </div>
        </div>

    </div>

    <!-- Footer Credits -->
    <footer class="text-center mt-12 mb-8 text-sm text-gray-500">
        <p>Built with love for Eorzea's fashionistas.</p>
        <p class="mt-2">
            Created by <a href="https://na.finalfantasyxiv.com/lodestone/character/7677106/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">Flash Galatine</a> (Balmung)
        </p>
        <p class="mt-2 flex justify-center gap-4 flex-wrap">
            <a href="https://blog.projectgalatine.com/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                Blog
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="https://github.com/FlashGalatine/xivdyetools" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                GitHub
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="https://x.com/AsheJunius" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                X / Twitter
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="https://www.twitch.tv/flashgalatine" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                Twitch
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="https://bsky.app/profile/flashgalatine.bsky.social" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                BlueSky
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="https://patreon.com/ProjectGalatine" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 transition">
                Patreon
            </a>
            <span class="text-gray-400">â€¢</span>
            <a href="./LICENSE" class="text-indigo-600 hover:text-indigo-800 transition">
                License (MIT)
            </a>
        </p>
        <p class="mt-4 text-xs text-gray-400">
            This is a fan-made tool and is not affiliated with or endorsed by Square Enix Co., Ltd.<br>
            FINAL FANTASY is a registered trademark of Square Enix Holdings Co., Ltd.
        </p>
    </footer>

    <script>
        /**
         * Toggle dropdown menu
         */
        function toggleDropdown(button) {
            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('show');

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-dropdown')) {
                    dropdown.classList.remove('show');
                }
            }, { once: true });
        }

        // Market Board price categories
        const PRICE_CATEGORIES = {
            'baseDyes': { name: 'Base Dyes', acquisitions: ['Dye Vendor', 'Ixali Vendor'], default: false },
            'craftDyes': { name: 'Craft Dyes', acquisitions: ['Crafting'], default: true },
            'beastTribeDyes': { name: 'Beast Tribe Dyes', acquisitions: ['Amalj\'aa Vendor', 'Sahagin Vendor', 'Kobold Vendor', 'Sylphic Vendor'], default: false },
            'cosmicDyes': { name: 'Cosmic Dyes', acquisitions: ['Cosmic Exploration', 'Cosmic Fortunes'], default: true },
            'specialDyes': { name: 'Special Dyes', category: 'Special', default: true }
        };

        // This variable will hold the color data once it's fetched.
        let ffxivDyes = [];
        let mbPriceCache = {};
        let mbLastPriceUpdate = null;

        // --- DOM Elements ---
        const mainContainer = document.getElementById('mainContainer');
        const colorPicker = document.getElementById('colorPicker');
        const resultsDiv = document.getElementById('results');
        const userColorDiv = document.getElementById('userColor');
        const userHexP = document.getElementById('userHex');
        const matchedColorDiv = document.getElementById('matchedColor');
        const matchedNameP = document.getElementById('matchedName');
        const matchedHexP = document.getElementById('matchedHex');
        
        const imageLoader = document.getElementById('imageLoader');
        const imageContainer = document.getElementById('imageContainer');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const canvasWrapper = document.getElementById('canvasWrapper');
        const sampleSizeSelect = document.getElementById('sampleSize');
        const eyedropperPreview = document.getElementById('eyedropperPreview');
        const excludeMetallicCheckbox = document.getElementById('excludeMetallic');
        const excludeExtremesCheckbox = document.getElementById('excludeExtremes');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomToFitBtn = document.getElementById('zoomToFitBtn');
        const zoomToWidthBtn = document.getElementById('zoomToWidthBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        const zoomLevelSpan = document.getElementById('zoomLevel');

        // Zoom and pan state
        let zoomScale = 1.0;
        let originalImageWidth = 0;
        let originalImageHeight = 0;
        let currentImage = null;
        let isPanning = false;
        let startPanX = 0;
        let startPanY = 0;

        /**
         * Initializes dark mode
         */
        function initializeDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            });
        }

        /**
         * Updates the canvas display based on current zoom
         */
        function updateCanvasZoom() {
            if (!currentImage) return;

            const newWidth = originalImageWidth * zoomScale;
            const newHeight = originalImageHeight * zoomScale;

            canvas.width = newWidth;
            canvas.height = newHeight;
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(currentImage, 0, 0, newWidth, newHeight);

            zoomLevelSpan.textContent = Math.round(zoomScale * 100) + '%';
        }

        /**
         * Zooms in on the image
         */
        function zoomIn() {
            zoomScale = Math.min(zoomScale * 1.25, 10); // Max 10x zoom
            updateCanvasZoom();
        }

        /**
         * Zooms out on the image
         */
        function zoomOut() {
            zoomScale = Math.max(zoomScale / 1.25, 0.25); // Min 0.25x zoom
            updateCanvasZoom();
        }

        /**
         * Resets zoom to 100%
         */
        function resetZoom() {
            zoomScale = 1.0;
            updateCanvasZoom();
            canvasWrapper.scrollLeft = 0;
            canvasWrapper.scrollTop = 0;
        }

        /**
         * Zooms to fit the image in the canvas wrapper
         */
        function zoomToFit() {
            if (!currentImage) return;

            const wrapperWidth = canvasWrapper.clientWidth;
            const wrapperHeight = canvasWrapper.clientHeight;

            const scaleX = wrapperWidth / originalImageWidth;
            const scaleY = wrapperHeight / originalImageHeight;

            // Use the smaller scale to ensure the entire image fits
            zoomScale = Math.min(scaleX, scaleY, 1.0); // Don't zoom in beyond 100%
            updateCanvasZoom();
            canvasWrapper.scrollLeft = 0;
            canvasWrapper.scrollTop = 0;
        }

        /**
         * Zooms to fit the image width in the canvas wrapper
         */
        function zoomToWidth() {
            if (!currentImage) return;

            const wrapperWidth = canvasWrapper.clientWidth;
            zoomScale = wrapperWidth / originalImageWidth;
            updateCanvasZoom();
            canvasWrapper.scrollLeft = 0;
            canvasWrapper.scrollTop = 0;
        }

        /**
         * Clears the loaded image
         */
        function clearImage() {
            currentImage = null;
            zoomScale = 1.0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            imageContainer.style.display = 'none';
            imageLoader.value = '';
        }

        // --- Core Functions ---
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        function rgbToHex(r, g, b) {
            const componentToHex = (c) => ('0' + Math.round(c).toString(16)).slice(-2);
            return `#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`;
        }

        function colorDistance(rgb1, rgb2) {
            const rDiff = rgb1.r - rgb2.r;
            const gDiff = rgb1.g - rgb2.g;
            const bDiff = rgb1.b - rgb2.b;
            return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff);
        }

        function findClosestMatch() {
            if (ffxivDyes.length === 0) {
                console.log("Color data not loaded yet.");
                return; // Don't run if data isn't loaded
            }

            const userHex = colorPicker.value;
            const userRgb = hexToRgb(userHex);
            if (!userRgb) return;

            const isMetallicExcluded = excludeMetallicCheckbox.checked;
            const isExtremesExcluded = excludeExtremesCheckbox.checked;

            // Apply all filters
            let dyesToSearch = ffxivDyes.filter(dye => {
                // Always exclude Facewear colors
                if (dye.category === 'Facewear') return false;

                // Exclude metallic if checkbox is checked
                if (isMetallicExcluded && dye.name.toLowerCase().includes('metallic')) return false;

                // Exclude Pure White and Jet Black if checkbox is checked
                if (isExtremesExcluded && (dye.name === 'Pure White' || dye.name === 'Jet Black')) return false;

                return true;
            });

            let closestColor = null;
            let smallestDistance = Infinity;

            dyesToSearch.forEach(dye => {
                const dyeRgb = hexToRgb(dye.hex);
                if (dyeRgb) {
                    const distance = colorDistance(userRgb, dyeRgb);
                    if (distance < smallestDistance) {
                        smallestDistance = distance;
                        closestColor = dye;
                    }
                }
            });
            updateResultsUI(userHex, closestColor);
        }
        
        function updateResultsUI(userHex, matchedDye) {
            userColorDiv.style.backgroundColor = userHex;
            userHexP.textContent = userHex.toUpperCase();
            if (matchedDye) {
                matchedColorDiv.style.backgroundColor = matchedDye.hex;
                matchedNameP.textContent = matchedDye.name;

                // Display hex and price
                let hexDisplay = matchedDye.hex.toUpperCase();
                if (document.getElementById('show-mb-prices-toggle').checked && shouldFetchPriceMatcher(matchedDye)) {
                    const itemIdKey = matchedDye.itemID.toString();
                    if (mbPriceCache[itemIdKey]) {
                        hexDisplay += ` â€¢ ${mbPriceCache[itemIdKey].toLocaleString()} Gil`;
                    }
                }
                matchedHexP.textContent = hexDisplay;
            } else {
                matchedColorDiv.style.backgroundColor = '#FFFFFF';
                matchedNameP.textContent = 'No Match Found';
                matchedHexP.textContent = '';
            }
            resultsDiv.classList.remove('hidden');
        }

        // --- Image & Eyedropper Functions ---
        function processImageFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                console.error("File is not a valid image.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    originalImageWidth = img.width;
                    originalImageHeight = img.height;
                    zoomScale = 1.0;
                    imageContainer.style.display = 'block';

                    // Auto zoom handling for large images
                    const wrapperWidth = canvasWrapper.clientWidth;
                    const wrapperHeight = canvasWrapper.clientHeight;
                    if (img.width > wrapperWidth || img.height > wrapperHeight) {
                        // For portrait images or images significantly taller than the wrapper, use zoom to width
                        if (img.height > img.width || img.height > wrapperHeight * 1.5) {
                            zoomToWidth();
                        } else {
                            zoomToFit();
                        }
                    } else {
                        updateCanvasZoom();
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function getAverageColor(x, y) {
            const size = parseInt(sampleSizeSelect.value, 10);
            const halfSize = Math.floor(size / 2);
            const startX = Math.max(0, Math.floor(x - halfSize));
            const startY = Math.max(0, Math.floor(y - halfSize));
            const endX = Math.min(ctx.canvas.width, startX + size);
            const endY = Math.min(ctx.canvas.height, startY + size);
            const sampleWidth = endX - startX;
            const sampleHeight = endY - startY;

            if (sampleWidth <= 0 || sampleHeight <= 0) return '#000000';

            const imageData = ctx.getImageData(startX, startY, sampleWidth, sampleHeight);
            const data = imageData.data;
            let r = 0, g = 0, b = 0;
            const numPixels = sampleWidth * sampleHeight;

            for (let i = 0; i < data.length; i += 4) {
                r += data[i]; g += data[i+1]; b += data[i+2];
            }
            return rgbToHex(r / numPixels, g / numPixels, b / numPixels);
        }
        
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { 
                x: (e.clientX - rect.left) * scaleX, 
                y: (e.clientY - rect.top) * scaleY 
            };
        }

        function handleCanvasMouseMove(e) {
            const { x, y } = getCanvasCoordinates(e);
            const avgColorHex = getAverageColor(x, y);
            
            eyedropperPreview.style.backgroundColor = avgColorHex;
            eyedropperPreview.style.left = `${e.clientX - mainContainer.getBoundingClientRect().left - 40}px`;
            eyedropperPreview.style.top = `${e.clientY - mainContainer.getBoundingClientRect().top - 40}px`;
        }
        
        function handleCanvasClick(e) {
            const { x, y } = getCanvasCoordinates(e);
            colorPicker.value = getAverageColor(x, y);
            findClosestMatch();
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            colorPicker.addEventListener('input', findClosestMatch);
            imageLoader.addEventListener('change', (e) => processImageFile(e.target.files[0]));
            excludeMetallicCheckbox.addEventListener('change', findClosestMatch);
            excludeExtremesCheckbox.addEventListener('change', findClosestMatch);

            // Zoom and clear buttons
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            zoomToFitBtn.addEventListener('click', zoomToFit);
            zoomToWidthBtn.addEventListener('click', zoomToWidth);
            resetZoomBtn.addEventListener('click', resetZoom);
            clearImageBtn.addEventListener('click', clearImage);

            // Keyboard shortcuts for zoom
            document.addEventListener('keydown', (e) => {
                if (imageContainer.style.display === 'none') return;

                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomIn();
                } else if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    zoomOut();
                } else if (e.key === 'w' || e.key === 'W') {
                    e.preventDefault();
                    zoomToWidth();
                } else if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    resetZoom();
                }
            });

            // Shift+MouseWheel for zoom
            canvasWrapper.addEventListener('wheel', (e) => {
                if (e.shiftKey) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        zoomIn();
                    } else {
                        zoomOut();
                    }
                }
            }, { passive: false });

            // Shift+LeftClickDrag for panning
            canvasWrapper.addEventListener('mousedown', (e) => {
                if (e.shiftKey && e.button === 0) {
                    // Shift+LeftClick
                    e.preventDefault();
                    isPanning = true;
                    startPanX = e.clientX + canvasWrapper.scrollLeft;
                    startPanY = e.clientY + canvasWrapper.scrollTop;
                    canvasWrapper.style.cursor = 'grabbing';
                } else if (e.shiftKey && e.button === 1) {
                    // Shift+MiddleClick - Zoom to Fit
                    e.preventDefault();
                    zoomToFit();
                } else if (e.shiftKey && e.button === 2) {
                    // Shift+RightClick - Reset Zoom
                    e.preventDefault();
                    resetZoom();
                }
            });

            // Prevent context menu on Shift+RightClick
            canvasWrapper.addEventListener('contextmenu', (e) => {
                if (e.shiftKey) {
                    e.preventDefault();
                }
            });

            document.addEventListener('mouseup', () => {
                if (isPanning) {
                    isPanning = false;
                    canvasWrapper.style.cursor = '';
                }
            });

            canvasWrapper.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    e.preventDefault();
                    canvasWrapper.scrollLeft = startPanX - e.clientX;
                    canvasWrapper.scrollTop = startPanY - e.clientY;
                }
            });

            let rect;
            canvas.addEventListener('mouseenter', () => {
                rect = canvas.getBoundingClientRect();
                eyedropperPreview.style.display = 'block';
            });
            canvas.addEventListener('mouseleave', () => eyedropperPreview.style.display = 'none');
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('click', handleCanvasClick);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                document.body.addEventListener(eventName, () => mainContainer.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, () => mainContainer.classList.remove('drag-over'));
            });

            document.body.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                processImageFile(file);
            });
        }

        /**
         * Check if a dye should have its price fetched
         */
        function shouldFetchPriceMatcher(color) {
            if (!color.itemID) return false;

            const baseDyes = document.getElementById('mb-price-base').checked;
            const craftDyes = document.getElementById('mb-price-craft').checked;
            const beastTribeDyes = document.getElementById('mb-price-beast').checked;
            const cosmicDyes = document.getElementById('mb-price-cosmic').checked;
            const specialDyes = document.getElementById('mb-price-special').checked;

            if (specialDyes && color.category === 'Special') return true;

            if (baseDyes && PRICE_CATEGORIES.baseDyes.acquisitions.includes(color.acquisition)) return true;
            if (craftDyes && PRICE_CATEGORIES.craftDyes.acquisitions.includes(color.acquisition)) return true;
            if (beastTribeDyes && PRICE_CATEGORIES.beastTribeDyes.acquisitions.some(acq => color.acquisition === acq)) return true;
            if (cosmicDyes && PRICE_CATEGORIES.cosmicDyes.acquisitions.includes(color.acquisition)) return true;

            return false;
        }

        /**
         * Fetches market prices from Universalis API
         */
        async function fetchMarketPricesMatcher(itemIds, server) {
            if (itemIds.length === 0) return {};

            const serverValue = server.startsWith('DC:') ? server.substring(3) : server.substring(6);
            const itemIdsString = itemIds.join(',');
            const url = `https://universalis.app/api/v2/aggregated/${serverValue}/${itemIdsString}`;

            try {
                console.log(`Fetching prices from: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const prices = {};

                if (data.results && Array.isArray(data.results)) {
                    data.results.forEach(result => {
                        const itemId = result.itemId.toString();

                        if (result.nq && result.nq.minListing) {
                            let price = null;

                            if (server.startsWith('DC:') && result.nq.minListing.dc && result.nq.minListing.dc.price) {
                                price = result.nq.minListing.dc.price;
                            }
                            else if (server.startsWith('WORLD:')) {
                                if (result.nq.minListing.world && result.nq.minListing.world.price) {
                                    price = result.nq.minListing.world.price;
                                } else if (result.nq.minListing.dc && result.nq.minListing.dc.price) {
                                    price = result.nq.minListing.dc.price;
                                }
                            }

                            if (!price && result.nq.minListing.region && result.nq.minListing.region.price) {
                                price = result.nq.minListing.region.price;
                            }

                            if (price) {
                                prices[itemId] = price;
                            }
                        }
                    });
                }

                console.log(`Successfully fetched prices for ${Object.keys(prices).length} items`);
                return prices;
            } catch (error) {
                console.error('Error fetching prices:', error);
                throw error;
            }
        }

        /**
         * Refreshes market prices
         */
        async function refreshMarketPricesMatcher() {
            const refreshBtn = document.getElementById('mb-refresh-btn');
            const statusDiv = document.getElementById('mb-price-status');
            const serverSelect = document.getElementById('mb-server-select');

            // Validate server is selected
            const server = serverSelect.value;
            if (!server || server === '') {
                statusDiv.textContent = 'Please select a server first.';
                return;
            }

            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Fetching Prices...';
            statusDiv.textContent = 'Connecting to Universalis API...';

            try {

                // Get the matched dye
                const matchedName = document.getElementById('matchedName').textContent;
                if (!matchedName) {
                    statusDiv.textContent = 'Select a color first to fetch prices.';
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh Prices';
                    return;
                }

                const matchedDye = ffxivDyes.find(d => d.name === matchedName);
                if (!matchedDye || !shouldFetchPriceMatcher(matchedDye)) {
                    statusDiv.textContent = 'No prices available for this dye.';
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh Prices';
                    return;
                }

                const itemIds = [matchedDye.itemID];
                const newPrices = await fetchMarketPricesMatcher(itemIds, server);

                mbPriceCache = { ...mbPriceCache, ...newPrices };
                mbLastPriceUpdate = new Date();

                // Update the display
                updateResultsUI(document.getElementById('userHex').textContent, matchedDye);

                statusDiv.textContent = `Updated at ${mbLastPriceUpdate.toLocaleTimeString()}`;

            } catch (error) {
                if (mbLastPriceUpdate) {
                    statusDiv.textContent = `Using cached data. Error: Cannot connect to Universalis API.`;
                } else {
                    statusDiv.textContent = 'Cannot connect to Universalis API.';
                }
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Prices';
            }
        }

        /**
         * Initialize Market Board server select
         */
        async function initializeMarketBoard() {
            try {
                const [dcResponse, worldsResponse] = await Promise.all([
                    fetch('./assets/json/data-centers.json'),
                    fetch('./assets/json/worlds.json')
                ]);

                const dataCenters = await dcResponse.json();
                const worlds = await worldsResponse.json();

                const serverSelect = document.getElementById('mb-server-select');
                serverSelect.innerHTML = '';

                // Add Data Centers
                const dcOptgroup = document.createElement('optgroup');
                dcOptgroup.label = 'Data Centers';
                dataCenters.forEach(dc => {
                    const option = document.createElement('option');
                    option.value = `DC:${dc.name}`;
                    option.textContent = `${dc.name} (${dc.region})`;
                    if (dc.name === 'Crystal') {
                        option.selected = true;
                    }
                    dcOptgroup.appendChild(option);
                });
                serverSelect.appendChild(dcOptgroup);

                // Add Worlds
                dataCenters.forEach(dc => {
                    const worldOptgroup = document.createElement('optgroup');
                    worldOptgroup.label = `${dc.name} Worlds`;

                    const dcWorlds = worlds
                        .filter(w => dc.worlds.includes(w.id))
                        .sort((a, b) => a.name.localeCompare(b.name));

                    dcWorlds.forEach(world => {
                        const option = document.createElement('option');
                        option.value = `WORLD:${world.id}`;
                        option.textContent = world.name;
                        worldOptgroup.appendChild(option);
                    });

                    serverSelect.appendChild(worldOptgroup);
                });

                // Setup toggle listener
                const priceToggle = document.getElementById('show-mb-prices-toggle');
                const priceSettings = document.getElementById('mb-price-settings');

                priceToggle.addEventListener('change', () => {
                    priceSettings.style.display = priceToggle.checked ? 'block' : 'none';
                    // Update the matched color display to show/hide price
                    const matchedName = document.getElementById('matchedName').textContent;
                    if (matchedName && matchedName !== 'No Match Found') {
                        const matchedDye = ffxivDyes.find(d => d.name === matchedName);
                        if (matchedDye) {
                            updateResultsUI(document.getElementById('userHex').textContent, matchedDye);
                        }
                    }
                });

                // Enable refresh button now that data is loaded
                const refreshBtn = document.getElementById('mb-refresh-btn');
                refreshBtn.disabled = false;

            } catch (error) {
                console.error('Error initializing market board:', error);
                const statusDiv = document.getElementById('mb-price-status');
                statusDiv.textContent = 'Error loading server data.';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dark mode
            initializeDarkMode();

            // Initialize market board
            initializeMarketBoard();

            fetch('./assets/json/colors_xiv.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    ffxivDyes = data; // Load data into the global variable
                    console.log('Color data loaded successfully.');
                    setupEventListeners(); // Set up event listeners after data is loaded
                    findClosestMatch();   // Perform initial match
                })
                .catch(error => {
                    console.error('Error loading color data:', error);
                    alert('Could not load color data. Please make sure colors_xiv.json is in the assets/json directory.');
                });
        });

    </script>

</body>
</html>
