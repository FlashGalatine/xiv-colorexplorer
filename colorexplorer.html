<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV Color Harmony Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">FFXIV Dye Color Explorer</h1>
            <p class="text-md text-gray-600 mt-2">Discover color harmonies using the FFXIV dye palette.</p>
        </header>

        <main>
            <div class="max-w-md mx-auto mb-4">
                <label for="color-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Base Color:</label>
                <select id="color-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <div class="max-w-md mx-auto mb-8 flex items-center justify-center">
                <input id="exclude-metallic-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="exclude-metallic-checkbox" class="ml-2 block text-sm font-medium text-gray-700">
                    Exclude Metallic Colors
                </label>
            </div>

            <div id="selected-color-display" class="mb-12 p-6 rounded-lg shadow-lg flex flex-col items-center transition-colors duration-500">
                <!-- Selected color details will be shown here -->
            </div>

            <div id="harmony-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Color harmony sections will be populated here -->
            </div>
        </main>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Built with love for Eorzea's fashionistas.</p>
        </footer>
    </div>

    <script>
        let colorData = [];

        /**
         * Sorts the color data and populates the dropdown with <optgroup> elements.
         */
        function populateDropdown() {
            const select = document.getElementById('color-select');
            select.innerHTML = ''; // Clear previous options

            // Sort the color data based on the new category order
            colorData.sort((a, b) => {
                const categoryOrder = {
                    'Neutral': 1, // Will be sorted first
                    'Special': 3  // Will be sorted last
                };
                // All other categories get a default order of 2
                const aOrder = categoryOrder[a.category] || 2;
                const bOrder = categoryOrder[b.category] || 2;

                // 1. Sort by the custom order (Neutral, then others, then Special)
                if (aOrder !== bOrder) {
                    return aOrder - bOrder;
                }

                // 2. If in the same order group, sort by category name alphabetically
                const categoryComparison = a.category.localeCompare(b.category);
                if (categoryComparison !== 0) {
                    return categoryComparison;
                }

                // 3. If category is also the same, sort by color name
                return a.name.localeCompare(b.name);
            });

            // Populate the dropdown with sorted and grouped options
            let currentCategory = '';
            let currentOptgroup = null;

            colorData.forEach((color, index) => {
                if (color.category !== currentCategory) {
                    currentCategory = color.category;
                    currentOptgroup = document.createElement('optgroup');
                    currentOptgroup.label = currentCategory;
                    select.appendChild(currentOptgroup);
                }

                const option = document.createElement('option');
                option.value = index; // The value is the index in the *sorted* array
                option.textContent = color.name;
                
                if (currentOptgroup) {
                    currentOptgroup.appendChild(option);
                } else {
                    select.appendChild(option);
                }
            });
        }

        /**
         * Calculates the Euclidean distance between two RGB colors.
         */
        function colorDistance(rgb1, rgb2) {
            const dr = rgb1.r - rgb2.r;
            const dg = rgb1.g - rgb2.g;
            const db = rgb1.b - rgb2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db);
        }

        /**
         * Converts an HSV color object to an RGB color object.
         */
        function hsvToRgb({ h, s, v }) {
            s /= 100;
            v /= 100;
            let c = v * s;
            let x = c * (1 - Math.abs(((h / 60) % 2) - 1));
            let m = v - c;
            let r_prime, g_prime, b_prime;

            if (h >= 0 && h < 60) { [r_prime, g_prime, b_prime] = [c, x, 0]; }
            else if (h >= 60 && h < 120) { [r_prime, g_prime, b_prime] = [x, c, 0]; }
            else if (h >= 120 && h < 180) { [r_prime, g_prime, b_prime] = [0, c, x]; }
            else if (h >= 180 && h < 240) { [r_prime, g_prime, b_prime] = [0, x, c]; }
            else if (h >= 240 && h < 300) { [r_prime, g_prime, b_prime] = [x, 0, c]; }
            else { [r_prime, g_prime, b_prime] = [c, 0, x]; }

            return {
                r: Math.round((r_prime + m) * 255),
                g: Math.round((g_prime + m) * 255),
                b: Math.round((b_prime + m) * 255)
            };
        }

        /**
         * Finds the closest color in our dataset to a target RGB color,
         * with an option to exclude metallic colors.
         */
        function findClosestColor(targetRgb) {
            const excludeMetallic = document.getElementById('exclude-metallic-checkbox').checked;
            let closestColor = null;
            let minDistance = Infinity;

            // Determine the list of colors to search through based on the checkbox
            const searchableColors = excludeMetallic
                ? colorData.filter(color => !color.name.toLowerCase().includes('metallic'))
                : colorData;

            // Fallback to the full list if the filtered list is empty
            const sourceToSearch = searchableColors.length > 0 ? searchableColors : colorData;

            sourceToSearch.forEach(color => {
                const distance = colorDistance(targetRgb, color.rgb);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = color;
                }
            });
            return closestColor;
        }

        /**
         * Generates a color harmony palette based on a base color.
         */
        function generateHarmony(baseColor, type) {
            const { h, s, v } = baseColor.hsv;
            let targetHues = [];

            switch (type) {
                case 'complementary':
                    targetHues = [(h + 180) % 360];
                    break;
                case 'analogous':
                    targetHues = [(h + 330) % 360, (h + 30) % 360];
                    break;
                case 'triadic':
                    targetHues = [(h + 120) % 360, (h + 240) % 360];
                    break;
                case 'split-complementary':
                    targetHues = [(h + 150) % 360, (h + 210) % 360];
                    break;
                case 'tetradic':
                    targetHues = [(h + 60) % 360, (h + 180) % 360, (h + 240) % 360];
                    break;
                case 'square':
                    targetHues = [(h + 90) % 360, (h + 180) % 360, (h + 270) % 360];
                    break;
            }

            return targetHues.map(targetH => {
                const targetRgb = hsvToRgb({ h: targetH, s: s, v: v });
                return findClosestColor(targetRgb);
            });
        }

        /**
         * Renders a single color swatch component.
         */
        function createColorSwatchHTML(color) {
            const textColor = (color.rgb.r * 0.299 + color.rgb.g * 0.587 + color.rgb.b * 0.114) > 186 ? 'text-black' : 'text-white';
            return `
                <div class="flex items-center p-3 rounded-lg" style="background-color: ${color.hex};">
                    <div class="w-8 h-8 rounded-md border-2 ${textColor === 'text-black' ? 'border-gray-300' : 'border-gray-500'}" style="background-color: ${color.hex};"></div>
                    <div class="ml-4 flex-grow ${textColor}">
                        <div class="font-semibold">${color.name}</div>
                        <div class="text-sm opacity-80">${color.hex.toUpperCase()}</div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Updates the entire UI based on the selected color.
         */
        function updateUI() {
            const select = document.getElementById('color-select');
            const selectedIndex = select.value;
            const baseColor = colorData[selectedIndex];

            const selectedColorDisplay = document.getElementById('selected-color-display');
            const selectedTextColor = (baseColor.rgb.r * 0.299 + baseColor.rgb.g * 0.587 + baseColor.rgb.b * 0.114) > 186 ? 'text-black' : 'text-white';
            selectedColorDisplay.style.backgroundColor = baseColor.hex;
            selectedColorDisplay.innerHTML = `
                <h2 class="text-2xl font-bold ${selectedTextColor}">${baseColor.name}</h2>
                <p class="text-lg ${selectedTextColor} opacity-90">${baseColor.hex.toUpperCase()}</p>
                <p class="text-sm ${selectedTextColor} opacity-80">RGB: (${baseColor.rgb.r}, ${baseColor.rgb.g}, ${baseColor.rgb.b})</p>
            `;

            const harmonies = [
                { name: 'Complementary', type: 'complementary' },
                { name: 'Analogous', type: 'analogous' },
                { name: 'Triadic', type: 'triadic' },
                { name: 'Split-Complementary', type: 'split-complementary' },
                { name: 'Tetradic (Rectangular)', type: 'tetradic' },
                { name: 'Square', type: 'square' },
            ];

            const resultsContainer = document.getElementById('harmony-results');
            resultsContainer.innerHTML = '';

            harmonies.forEach(harmony => {
                const palette = generateHarmony(baseColor, harmony.type);
                const section = document.createElement('div');
                section.className = 'bg-white p-4 rounded-lg shadow-md';
                
                let swatchesHTML = palette.map(createColorSwatchHTML).join('<div class="my-2"></div>');

                section.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">${harmony.name}</h3>
                    <div class="space-y-2">${swatchesHTML}</div>
                `;
                resultsContainer.appendChild(section);
            });
        }


        // --- Initialization ---
        window.onload = async () => {
            try {
                // Fetch the color data from the external JSON file
                const response = await fetch('colors.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                colorData = await response.json();
                
                // Once data is loaded, initialize the page
                populateDropdown();
                
                const select = document.getElementById('color-select');
                select.addEventListener('change', updateUI);

                const checkbox = document.getElementById('exclude-metallic-checkbox');
                checkbox.addEventListener('change', updateUI);
                
                updateUI();
            } catch (error) {
                console.error("Could not load color data:", error);
                const main = document.querySelector('main');
                main.innerHTML = `<p class="text-center text-red-500">Error: Could not load color data. Please make sure the colors.json file is in the same directory.</p>`;
            }
        };

    </script>
</body>
</html>
