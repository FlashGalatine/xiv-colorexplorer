const THEME_KEY='xivdyetools_theme';function getThemeColor(varName){const cleanVarName=varName.startsWith('--')?varName:`--${varName}`;const value=getComputedStyle(document.body).getPropertyValue(cleanVarName).trim();return value}function safeGetStorage(key,defaultValue){try{const value=localStorage.getItem(key);return value!==null?value:defaultValue}catch(error){console.error(`Error reading from localStorage(key:${key}):`,error);return defaultValue}}function safeSetStorage(key,value){try{localStorage.setItem(key,value)}catch(error){if(error.name==='QuotaExceededError'){console.warn(`localStorage quota exceeded for key:${key}`)}else{console.error(`Error writing to localStorage(key:${key}):`,error)}}}function safeFetchJSON(url,fallbackData=[]){return fetch(url).then(response=>{const contentType=response.headers.get('content-type');console.log(`[safeFetchJSON]Fetching ${url}:HTTP ${response.status},Content-Type:${contentType}`);if(!response.ok){throw new Error(`HTTP ${response.status}:${response.statusText}`)}return response.text().then(text=>{console.log(`[safeFetchJSON]Response received,length:${text.length}chars`);try{const data=JSON.parse(text);console.log(`[safeFetchJSON]Successfully parsed JSON from ${url}`);return data}catch(parseError){console.error(`[safeFetchJSON]JSON parse failed for ${url}:`,parseError.message);console.error(`[safeFetchJSON]Response preview(first 300 chars):${text.substring(0,300)}`);throw new Error(`Invalid JSON response:${parseError.message}`)}})}).catch(error=>{console.error(`[safeFetchJSON]Failed to load JSON from ${url}:`,error.message);return fallbackData})}function hexToRgb(hex){const result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:{r:0,g:0,b:0}}function rgbToHex(r,g,b){const componentToHex=(c)=>('0'+Math.round(c).toString(16)).slice(-2);return `#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`}function rgbToHsv(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b);const min=Math.min(r,g,b);const delta=max-min;let h=0;if(delta===0)h=0;else if(max===r)h=((g-b)/delta+(g<b?6:0))/6;else if(max===g)h=((b-r)/delta+2)/6;else h=((r-g)/delta+4)/6;const s=max===0?0:delta/max;const v=max;return{h:Math.round(h*360),s:Math.round(s*100),v:Math.round(v*100)}}function hsvToRgb(h,s,v){s/=100;v/=100;const c=v*s;const x=c*(1-Math.abs(((h/60)% 2)-1));const m=v-c;let r_prime,g_prime,b_prime;if(h>=0 && h<60){[r_prime,g_prime,b_prime]=[c,x,0]}else if(h>=60 && h<120){[r_prime,g_prime,b_prime]=[x,c,0]}else if(h>=120 && h<180){[r_prime,g_prime,b_prime]=[0,c,x]}else if(h>=180 && h<240){[r_prime,g_prime,b_prime]=[0,x,c]}else if(h>=240 && h<300){[r_prime,g_prime,b_prime]=[x,0,c]}else{[r_prime,g_prime,b_prime]=[c,0,x]}return{r:Math.round((r_prime+m)*255),g:Math.round((g_prime+m)*255),b:Math.round((b_prime+m)*255)}}function colorDistance(rgb1,rgb2){if(!rgb1 ||!rgb2 || typeof rgb1.r!=='number' || typeof rgb2.r!=='number'){console.warn('Invalid color objects passed to colorDistance');return 0}const rDiff=rgb1.r-rgb2.r;const gDiff=rgb1.g-rgb2.g;const bDiff=rgb1.b-rgb2.b;return Math.sqrt(rDiff*rDiff+gDiff*gDiff+bDiff*bDiff)}function getColorDistance(hex1,hex2){const rgb1=hexToRgb(hex1);const rgb2=hexToRgb(hex2);return colorDistance(rgb1,rgb2)}function getCategoryPriority(category){const priorityMap={'Neutral':0,'Special':98,'Facewear':99};return priorityMap[category]!==undefined?priorityMap[category]:2}function sortDyesByCategory(dyes){return[...dyes].sort((a,b)=>{const aPriority=getCategoryPriority(a.category);const bPriority=getCategoryPriority(b.category);if(aPriority!==bPriority){return aPriority-bPriority}const categoryComparison=a.category.localeCompare(b.category);if(categoryComparison!==0){return categoryComparison}return a.name.localeCompare(b.name)})}function populateDyeDropdown(select,dyeArray=null){if(!select){console.warn('populateDyeDropdown:Invalid select element');return}const dyes=dyeArray ||(typeof ffxivDyes!=='undefined'?ffxivDyes:[]);if(!dyes || dyes.length===0){console.warn('populateDyeDropdown:No dye data available');return}const defaultOption=select.querySelector('option');if(defaultOption && defaultOption.textContent.includes('...')){while(select.children.length>1){select.removeChild(select.lastChild)}}else{select.innerHTML=''}const sortedDyes=sortDyesByCategory(dyes);const dyesByCategory={};sortedDyes.forEach(dye=>{if(!dyesByCategory[dye.category]){dyesByCategory[dye.category]=[]}dyesByCategory[dye.category].push(dye)});const categories=Object.keys(dyesByCategory).sort((a,b)=>{const aPriority=getCategoryPriority(a);const bPriority=getCategoryPriority(b);if(aPriority!==bPriority)return aPriority-bPriority;return a.localeCompare(b)});categories.forEach(category=>{const optgroup=document.createElement('optgroup');optgroup.label=category;dyesByCategory[category].forEach(dye=>{const option=document.createElement('option');option.value=dye.itemID;option.textContent=dye.name;optgroup.appendChild(option)});select.appendChild(optgroup)})}class APIThrottler{constructor(minInterval=500){this.minInterval=minInterval;this.lastRequest=0;this.queue=[];this.isProcessing=false}async request(url){return new Promise((resolve,reject)=>{this.queue.push({url,resolve,reject});this.processQueue()})}async processQueue(){if(this.isProcessing || this.queue.length===0)return;this.isProcessing=true;const now=Date.now();const timeSinceLastRequest=now-this.lastRequest;if(timeSinceLastRequest<this.minInterval){const waitTime=this.minInterval-timeSinceLastRequest;await new Promise(r=>setTimeout(r,waitTime))}const{url,resolve,reject}=this.queue.shift();try{const response=await fetch(url);const data=await response.json();this.lastRequest=Date.now();resolve(data)}catch(error){reject(error)}this.isProcessing=false;this.processQueue()}}const apiThrottler=new APIThrottler(500);function isTouchDevice(){return(('ontouchstart' in window)||(navigator.maxTouchPoints>0)||(navigator.msMaxTouchPoints>0))}function isMobile(breakpoint=768){return window.innerWidth<breakpoint}function isTablet(){return window.innerWidth>=768 && window.innerWidth<1024}function getViewportSize(){return{width:window.innerWidth,height:window.innerHeight,isMobile:isMobile(),isTablet:isTablet(),isTouchDevice:isTouchDevice()}}function getOrientation(){return window.innerHeight>window.innerWidth?'portrait':'landscape'}function debounce(func,delay=300){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>func.apply(this,args),delay)}}function throttle(func,limit=100){let inThrottle;return function(...args){if(!inThrottle){func.apply(this,args);inThrottle=true;setTimeout(()=>(inThrottle=false),limit)}}}function requestFrame(callback){return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||(fn=>setTimeout(fn,16))}function getTouchDistance(touch1,touch2){const dx=touch1.clientX-touch2.clientX;const dy=touch1.clientY-touch2.clientY;return Math.sqrt(dx*dx+dy*dy)}function getTouchMidpoint(touch1,touch2){return{x:(touch1.clientX+touch2.clientX)/2,y:(touch1.clientY+touch2.clientY)/2}}class TouchGestureManager{constructor(element){this.element=element;this.touchStart=null;this.lastTouchDistance=0;this.gestureCallbacks={onTap:null,onDoubleTap:null,onLongPress:null,onSwipe:null,onPinch:null,onPan:null};this.lastTapTime=0;this.doubleTapTimer=null;this.longPressTimer=null;this.minSwipeDistance=30;this.minPinchDistance=50;this.init()}init(){this.element.addEventListener('touchstart',(e)=>this.handleTouchStart(e),false);this.element.addEventListener('touchmove',(e)=>this.handleTouchMove(e),false);this.element.addEventListener('touchend',(e)=>this.handleTouchEnd(e),false);this.element.addEventListener('touchcancel',(e)=>this.handleTouchCancel(e),false)}on(gestureName,callback){if(this.gestureCallbacks.hasOwnProperty(gestureName)){this.gestureCallbacks[gestureName]=callback}}handleTouchStart(e){if(e.touches.length===1){this.touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY,time:Date.now()};this.longPressTimer=setTimeout(()=>{if(this.gestureCallbacks.onLongPress){this.gestureCallbacks.onLongPress({x:e.touches[0].clientX,y:e.touches[0].clientY})}},500)}else if(e.touches.length===2){this.lastTouchDistance=getTouchDistance(e.touches[0],e.touches[1])}}handleTouchMove(e){if(e.touches.length===1){if(this.longPressTimer){clearTimeout(this.longPressTimer)}if(this.touchStart && this.gestureCallbacks.onPan){const dx=e.touches[0].clientX-this.touchStart.x;const dy=e.touches[0].clientY-this.touchStart.y;this.gestureCallbacks.onPan({dx,dy,x:e.touches[0].clientX,y:e.touches[0].clientY})}}else if(e.touches.length===2){const currentDistance=getTouchDistance(e.touches[0],e.touches[1]);const delta=currentDistance-this.lastTouchDistance;if(Math.abs(delta)>this.minPinchDistance && this.gestureCallbacks.onPinch){const midpoint=getTouchMidpoint(e.touches[0],e.touches[1]);this.gestureCallbacks.onPinch({scale:currentDistance/this.lastTouchDistance,distance:currentDistance,previousDistance:this.lastTouchDistance,centerX:midpoint.x,centerY:midpoint.y,isZoomIn:currentDistance>this.lastTouchDistance})}this.lastTouchDistance=currentDistance}}handleTouchEnd(e){if(this.longPressTimer){clearTimeout(this.longPressTimer)}if(this.touchStart && e.changedTouches.length>0){const endX=e.changedTouches[0].clientX;const endY=e.changedTouches[0].clientY;const dx=endX-this.touchStart.x;const dy=endY-this.touchStart.y;const distance=Math.sqrt(dx*dx+dy*dy);const timeDelta=Date.now()-this.touchStart.time;if(distance>this.minSwipeDistance && this.gestureCallbacks.onSwipe){const angle=Math.atan2(dy,dx);let direction;if(Math.abs(dx)>Math.abs(dy)){direction=dx>0?'right':'left'}else{direction=dy>0?'down':'up'}this.gestureCallbacks.onSwipe({direction,dx,dy,angle,distance,velocity:distance/timeDelta})}else if(distance<10 && timeDelta<300){const now=Date.now();if(now-this.lastTapTime<300){if(this.gestureCallbacks.onDoubleTap){this.gestureCallbacks.onDoubleTap({x:endX,y:endY})}}else{if(this.gestureCallbacks.onTap){this.gestureCallbacks.onTap({x:endX,y:endY})}}this.lastTapTime=now}}this.touchStart=null;this.lastTouchDistance=0}handleTouchCancel(e){if(this.longPressTimer){clearTimeout(this.longPressTimer)}this.touchStart=null}destroy(){this.element.removeEventListener('touchstart',(e)=>this.handleTouchStart(e));this.element.removeEventListener('touchmove',(e)=>this.handleTouchMove(e));this.element.removeEventListener('touchend',(e)=>this.handleTouchEnd(e));this.element.removeEventListener('touchcancel',(e)=>this.handleTouchCancel(e))}}function getMobileStorageKey(key,prefix='mobile_'){return `${prefix}${key}`}function getMobileSetting(key,defaultValue){return safeGetStorage(getMobileStorageKey(key),defaultValue)}function setMobileSetting(key,value){safeSetStorage(getMobileStorageKey(key),value)}function triggerHaptic(duration=10){if('vibrate' in navigator){try{navigator.vibrate(duration)}catch(e){}}}function hapticSuccess(){triggerHaptic(20)}function hapticError(){if('vibrate' in navigator){try{navigator.vibrate([10,20,10])}catch(e){}}}function hapticLight(){triggerHaptic(10)}function migrateThemePreferences(){const oldKeys=['colorMatcher_darkMode','colorExplorer_darkMode','dyeComparison_darkMode'];const newKey=THEME_KEY;if(safeGetStorage(newKey,null)!==null){return}for(const oldKey of oldKeys){const wasDarkMode=safeGetStorage(oldKey,null);if(wasDarkMode==='true'){safeSetStorage(newKey,'standard-dark');console.log(`Migrated theme preference from ${oldKey}(dark)to ${newKey}`);break}}if(safeGetStorage(newKey,null)===null){safeSetStorage(newKey,'standard-light')}oldKeys.forEach(key=>{localStorage.removeItem(key)})}const AVAILABLE_THEMES=['standard-light','standard-dark','hydaelyn-light','hydaelyn-dark','classic-ff-light','classic-ff-dark','parchment-light','parchment-dark','sugar-riot-light','sugar-riot-dark'];function getThemeClassName(themeName){if(themeName==='standard-light'){return null}return themeName}function initTheme(){const savedTheme=safeGetStorage(THEME_KEY,'standard-light');setTheme(savedTheme)}function setTheme(themeName){if(!AVAILABLE_THEMES.includes(themeName)){console.warn(`Invalid theme:${themeName}. Defaulting to standard-light.`);themeName='standard-light'}AVAILABLE_THEMES.forEach(theme=>{document.body.classList.remove(`theme-${theme}`)});['theme-light','theme-dark','theme-hydaelyn','theme-classic-ff','theme-parchment','theme-sugar-riot'].forEach(className=>{document.body.classList.remove(className)});document.body.classList.remove('dark-mode');const themeClass=getThemeClassName(themeName);if(themeClass){document.body.classList.add(`theme-${themeClass}`)}safeSetStorage(THEME_KEY,themeName);window.dispatchEvent(new CustomEvent('themeChanged',{detail:{theme:themeName}}))}function getActiveTheme(){return safeGetStorage(THEME_KEY,'standard-light')}function toggleDropdown(button){const dropdown=button.nextElementSibling;if(!dropdown)return;dropdown.classList.toggle('show')}function toggleThemeSwitcher(button){const menu=button.nextElementSibling;if(!menu)return;menu.classList.toggle('show')}document.addEventListener('click',(e)=>{const toolsDropdown=document.querySelector('.nav-dropdown .nav-dropdown-menu.show');if(toolsDropdown &&!e.target.closest('.nav-dropdown')){toolsDropdown.classList.remove('show')}const themeMenu=document.querySelector('.theme-switcher .theme-switcher-menu.show');if(themeMenu &&!e.target.closest('.theme-switcher')){themeMenu.classList.remove('show')}});async function loadComponent(url,containerId){try{const response=await fetch(url);if(!response.ok){throw new Error(`HTTP ${response.status}:${response.statusText}`)}const html=await response.text();const container=document.getElementById(containerId);if(container){container.innerHTML=html}else{console.warn(`Container with ID "${containerId}" not found`)}}catch(error){console.error(`Failed to load component from ${url}:`,error);const container=document.getElementById(containerId);if(container){container.innerHTML=`<div style="padding:0.75rem;background-color:#fff3cd;color:#856404;border-radius:4px;font-size:12px;"><small><strong>⚠️</strong>Navigation unavailable(${error.message}).<a href="index.html" style="color:#856404;text-decoration:underline;">Return home</a></small></div>`}}}function initComponents(){loadComponent('components/nav.html','nav-container');loadComponent('components/footer.html','footer-container')}function removeLoadingPlaceholders(){document.querySelectorAll('.component-loading').forEach(el=>{el.classList.remove('component-loading')})}const PRICE_CATEGORIES={'baseDyes':{name:'Base Dyes',acquisitions:['Dye Vendor'],default:false},'craftDyes':{name:'Craft Dyes',acquisitions:['Crafting','Treasure Chest'],default:true},'alliedSocietyDyes':{name:'Allied Society Dyes',acquisitions:['Amalj\'aa Vendor','Ixali Vendor','Sahagin Vendor','Kobold Vendor','Sylphic Vendor'],default:false},'cosmicDyes':{name:'Cosmic Dyes',acquisitions:['Cosmic Exploration','Cosmic Fortunes'],default:true},'specialDyes':{name:'Special Dyes',category:'Special',default:true}};function shouldFetchPrice(dye){if(!dye)return false;if(!dye.itemID)return false;const specialCheckbox=document.getElementById('mb-price-special');if(specialCheckbox && specialCheckbox.checked && dye.category==='Special'){return true}if(!dye.acquisition)return false;const baseCheckbox=document.getElementById('mb-price-base');if(baseCheckbox && baseCheckbox.checked && PRICE_CATEGORIES.baseDyes.acquisitions.includes(dye.acquisition)){return true}const craftCheckbox=document.getElementById('mb-price-craft');if(craftCheckbox && craftCheckbox.checked && PRICE_CATEGORIES.craftDyes.acquisitions.includes(dye.acquisition)){return true}const alliedCheckbox=document.getElementById('mb-price-allied');if(alliedCheckbox && alliedCheckbox.checked && PRICE_CATEGORIES.alliedSocietyDyes.acquisitions.includes(dye.acquisition)){return true}const cosmicCheckbox=document.getElementById('mb-price-cosmic');if(cosmicCheckbox && cosmicCheckbox.checked && PRICE_CATEGORIES.cosmicDyes.acquisitions.includes(dye.acquisition)){return true}return false}async function initializeMarketBoard(selectElementId='mb-server-select'){try{const serverSelect=document.getElementById(selectElementId);if(!serverSelect){console.warn(`Market board select element not found:${selectElementId}`);return}const[dcResponse,worldsResponse]=await Promise.all([fetch('./assets/json/data-centers.json'),fetch('./assets/json/worlds.json')]);const dataCenters=await dcResponse.json();const worlds=await worldsResponse.json();serverSelect.innerHTML='';const sortedDataCenters=[...dataCenters].sort((a,b)=>a.name.localeCompare(b.name));const dcOptgroup=document.createElement('optgroup');dcOptgroup.label='Data Centers';sortedDataCenters.forEach(dc=>{const option=document.createElement('option');option.value=`DC:${dc.name}`;option.textContent=`${dc.name}(${dc.region})`;if(dc.name==='Crystal'){option.selected=true}dcOptgroup.appendChild(option)});serverSelect.appendChild(dcOptgroup);sortedDataCenters.forEach(dc=>{const worldOptgroup=document.createElement('optgroup');worldOptgroup.label=`${dc.name}Worlds`;const dcWorlds=worlds .filter(w=>dc.worlds.includes(w.id)).sort((a,b)=>a.name.localeCompare(b.name));dcWorlds.forEach(world=>{const option=document.createElement('option');option.value=`WORLD:${world.id}`;option.textContent=world.name;worldOptgroup.appendChild(option)});serverSelect.appendChild(worldOptgroup)});console.log(`Market board initialized with ${sortedDataCenters.length}data centers`)}catch(error){console.error('Error initializing market board:',error)}}async function fetchUniversalisPrice(itemIds,server,throttler){if(!itemIds || itemIds.length===0)return{};if(!throttler){console.warn('fetchUniversalisPrice:No throttler provided,using direct fetch');throttler=new APIThrottler(500)}try{const serverValue=server.startsWith('DC:')?server.substring(3):server.substring(6);const itemIdsString=itemIds.join(',');const url=`https:console.log(`Fetching prices from:${url}`);const data=await throttler.request(url);const prices={};if(data.results && Array.isArray(data.results)){data.results.forEach(result=>{const itemId=result.itemId.toString();if(result.nq && result.nq.minListing){let price=null;if(server.startsWith('DC:')&& result.nq.minListing.dc && result.nq.minListing.dc.price){price=result.nq.minListing.dc.price}else if(server.startsWith('WORLD:')){if(result.nq.minListing.world && result.nq.minListing.world.price){price=result.nq.minListing.world.price}else if(result.nq.minListing.dc && result.nq.minListing.dc.price){price=result.nq.minListing.dc.price}}if(!price && result.nq.minListing.region && result.nq.minListing.region.price){price=result.nq.minListing.region.price}if(price){prices[itemId]=price}}})}console.log(`Successfully fetched prices for ${Object.keys(prices).length}items`);return prices}catch(error){console.error('Error fetching prices from Universalis API:',error);throw error}}function formatPrice(price){if(!price)return 'N/A';return price.toLocaleString('en-US')+' gil'}function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)|| window.matchMedia('(max-width:768px)').matches}let lastViewportHeight=window.innerHeight;window.addEventListener('resize',function(){const currentHeight=window.innerHeight;const heightDifference=lastViewportHeight-currentHeight;if(Math.abs(heightDifference)>100 && isMobileDevice()){const focused=document.activeElement;if(focused && focused!==document.body){setTimeout(()=>{focused.scrollIntoView({behavior:'smooth',block:'center'})},100)}}lastViewportHeight=currentHeight});document.addEventListener('DOMContentLoaded',function(){if(!isMobileDevice())return;const inputs=document.querySelectorAll('input,select,textarea,button');inputs.forEach(input=>{input.addEventListener('focus',function(){this.classList.add('has-focus')});input.addEventListener('blur',function(){this.classList.remove('has-focus')});input.addEventListener('touchstart',function(e){if(e.touches.length>1){e.preventDefault()}})});window.addEventListener('orientationchange',function(){const viewport=document.querySelector('meta[name="viewport"]');if(viewport){viewport.setAttribute('content','width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no');setTimeout(()=>{viewport.setAttribute('content','width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=5.0')},500)}})});function focusAndScroll(element){if(!element)return;element.focus();if(isMobileDevice()){setTimeout(()=>{element.scrollIntoView({behavior:'smooth',block:'center'})},100)}}function closeKeyboard(){const focused=document.activeElement;if(focused && focused!==document.body){focused.blur()}}document.addEventListener('DOMContentLoaded',()=>{try{migrateThemePreferences();initTheme();initComponents();removeLoadingPlaceholders()}catch(error){console.error('Error in shared-components initialization:',error)}});